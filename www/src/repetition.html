<!DOCTYPE HTML>

<HTML>
<head>
    <link rel="stylesheet" href="dark.css">
    <link rel="stylesheet" href="layout.css">
    <link rel="stylesheet" href="repetition.css">

    <script>
        TestType = {
            "ShowNewWord": 0,
            "EngToJapan": 1,
            "JapanToEng": 2,
            "RealWriting": 3
        }
        
        class TestParts {
            constructor(word, testType) {
                this.word = word;
                this.testType = testType;
                this.passed = false;
            }
        }

        words = [];
        gameplayId = 0;
        register = [];
        done = [];
        repetitionSteps = ["ShowNewWords", "Repeat"];

        repetitionCaption = 0;
        repetitionAnswer = 0;
        buttIdk = 0;
        buttCheck = 0;
        buttOk = 0;

        answerForm = 0;

        function init(){
            let artIDE = localStorage.getItem("lastRepetitionId");
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "http://localhost:8000/api/gameplay/start", true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                artId: artIDE,
                numberOfToRepeat: 3
            }));

            xhr.onreadystatechange = function () {
                if (this.readyState != 4) return;

                if (this.status == 200) {
                    var data = JSON.parse(this.responseText);
                    gameplayId = data.gameplayId;
                    words = data.toRepeat;
                    onDataLoad();

                    // we get the returned data
                }

                // end of state change: it can be after some time (async)
            };


            fetch('repeat.json')
            .then((response) => response.json())
            .then((data) => {
                
            })
        }

        function onDataLoad(){
            loadElements();
            console.log(words);
            createRegister();
            console.log(register);
            loadNextTest();
        }

        function createRegister(){
            words.forEach(wordDesc => {
                if(wordDesc.isNew)
                    register.push(new TestParts(wordDesc,TestType.ShowNewWord));
            });
            words.forEach(wordDesc => {
                register.push(new TestParts(wordDesc,TestType.JapanToEng));
            });
            words.forEach(wordDesc => {
                register.push(new TestParts(wordDesc,TestType.EngToJapan));
                
            });
            words.forEach(wordDesc => {
                register.push(new TestParts(wordDesc,TestType.RealWriting));
            });
        }

        function loadElements(){
            repetitionCaption = document.getElementById("repetition-caption");
            repetitionAnswer = document.getElementById("repetition-answer");
            buttIdk = document.getElementById("butt-idk");
            buttCheck = document.getElementById("butt-check");
            buttOk = document.getElementById("butt-ok");
            answerForm = document.getElementById("submitAnswer");
            answerForm.addEventListener('submit',function(event){
                event.preventDefault();
                onCheckClick();
            });
        }

        function loadNextTest(){
            test = register[0];

            if(test == undefined){
                endGame();
                return;
            }

            console.log(test);

            if(test.testType == TestType.ShowNewWord){
                repetitionAnswer.style.display="none";
                buttIdk.style.display="none";
                buttCheck.style.display="none";
                buttOk.style.display="inline-block";
                repetitionCaption.innerHTML = test.word.goodWriteAnswers[0] + " = " + test.word.goodAnswers[1] + " = " + test.word.goodAnswers[0];
            }
            else {
                repetitionAnswer.style.display="block";
                buttIdk.style.display="inline-block";
                buttCheck.style.display="inline-block";
                buttOk.style.display="none";
                if(test.testType == TestType.JapanToEng)
                    repetitionCaption.innerHTML = test.word.goodWriteAnswers[0];
                else if(test.testType == TestType.EngToJapan)
                    repetitionCaption.innerHTML = test.word.goodAnswers[0];
                else if(test.testType == TestType.RealWriting)
                    repetitionCaption.innerHTML = test.word.goodWriteAnswers[0];
            }


            repetitionAnswer.value = "";
        }

        function onOkClick(){
            done.push(register[0]);
            register.shift();
            loadNextTest();
        }

        function onCheckClick(){
            test = register[0];
            answer = repetitionAnswer.value;
            goodAnswers = [];
            isAnswerGood = false;

            if(test.testType == TestType.JapanToEng){
                goodAnswers = test.word.goodAnswers;
            }
            else if(test.testType == TestType.RealWriting){
                goodAnswers = test.word.goodAnswers;
            }
            else{
                goodAnswers = test.word.goodWriteAnswers;
            }

            goodAnswers.forEach( word => {
                if(answer == word) isAnswerGood = true;
            });

            console.log(isAnswerGood);

            if(isAnswerGood){
                done.push(register[0]);
                register.shift();
                repetitionCaption.style.background="#44cc44";
            }
            else{
                register.push(register[0]);
                register.shift();
                repetitionCaption.style.background="#cc4444";
            }

            setTimeout(function(){
                repetitionCaption.style.background="#646262";
            }, 1000);

            loadNextTest();
        }

        function onIdkClick(){
            test = register[0];
            register.push(test);
            register.shift();
            register.unshift(new TestParts(test.word, TestType.ShowNewWord));
            loadNextTest();
        }

        function endGame(){
            document.getElementById("repetition-main").style.display="none";
            document.getElementById("repetition-results").style.display="block";


            
        }

        init();
        
    </script>
</head>

<body>
    <nav>
        <img class="logo" src="logo.svg"></img>
        <ul>
            <li><a href="learn.html">End session</a></li>
        </ul>
        <div id="rightSideButtons">
            <button class="butt b-secondary">Logout</button>
        </div>
    </nav>
    

    <div id="repetition-main" class="repetition-main">
        <div id="repetition-image-place">
            <div id="repetition-image" style='background-image: url("luckystar.png")'>
                <!-- <img class="repetition-img" src="luckystar.png"> -->
            </div>
            <div id="repetition-caption">
                Pablo
            </div>
        </div>

        <div id="repetition-answer-place">
            <form id="submitAnswer">
                <input type="text" class="input-text" id="repetition-answer" placeholder="Write answer here">
            </form>
        </div>

        <div id="repetition-answer-place">
            <button id="butt-idk" class="butt b-secondary" onclick="onIdkClick()">I don't know</button>
            <button id="butt-check" class="butt b-primary" onclick="onCheckClick()">Check</button>
            <button id="butt-ok" class="butt b-primary" onclick="onOkClick()">Ok</button>
        </div>
    </div>

    <div style="display:none" class="repetition-main" id="repetition-results">
        <div id="repetition-end">
            <h2>Repetition end!</h2>
        </div>
    </div>

</body>
</HTML>
