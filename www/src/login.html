<!DOCTYPE HTML>

<HTML>
<head>
    <link rel="stylesheet" href="dark.css">
    <link rel="stylesheet" href="login.css">
    <link rel="stylesheet" href="layout.css">
    <script type="text/javascript" src="session.js"></script>
    <title> Login - Kwoo</title>
</head>

<body>
    <nav>
        <img class="logo" src="logo.svg"></img>
        <ul>

        </ul>
        <div id="rightSideButtons">
            
        </div>
    </nav>

    <div id="login-container">
        <img class="logo" style="margin-left: 140px; margin-top: 10px; margin-bottom:20px" src="biglogo.svg" height="100"><br>
        <div id="login-left">
            <form id="login-form" class="w-100">
                <input class="butt b-secondary" name="login" type="text" placeholder="login" class="w-100"> <br><br>
                <input class="butt b-secondary" name="password" type="password" placeholder="password"><br><br>
                <input class="butt b-primary w-100" type="submit" value="Login">
            </form>
        </div>
        <div id="login-right">
            Welcome again! <br><br>
            No account? <a href="register.html">Register</a>
        </div>
    </div>
    <script>
        let form = document.querySelector("#login-form");
        form.addEventListener("submit", (e) => {
            e.preventDefault();

            //Lock form while sending request
            form["login"].readOnly = true;
            form["password"].readOnly = true;

            //Send request
            var xhr = new XMLHttpRequest();
            xhr.open("POST", "/api/auth/login", true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(JSON.stringify({
                login: form["login"].value,
                password: form["password"].value
            }));

            xhr.onreadystatechange = function () {
                //When it's already sent, we turn off lock
                form["login"].readOnly = false;
                form["password"].readOnly = false;

                if (this.readyState != 4) return;

                if (this.status == 200) {
                    var data = JSON.parse(this.responseText);
                    localStorage.setItem("token", data.token);
                    console.log(localStorage.getItem("token"));
                    localStorage.setItem("user", JSON.stringify(data.current_user));
                    document.location.href = "learn.html";
                }
            };
 
        });
    </script>

</body>
</HTML>
